{% extends 'project/base_detail.html' %}
{% block content %}
  <div class="page-wrapper">
    <div class="page-header d-print-none">
      <div class="container-xl">
        <div class="row g-2 align-items-center">
          <div class="col">
            <h2 class="page-title">
              Set my datas ground truth
            </h2>
          </div>
          <div class="col-auto ms-auto d-print-none">
          </div>
        </div>
      </div>
    </div>
    <div class="page-body">
      <div class="container-xl">
        <div class="row">
          <div class="col-12">
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">Cases Preview (max. 10)</h3>
              </div>
              <table class="table table-striped table-hover">
                <thead>
                <th>Case</th>
                <th>Terms</th>
                </thead>
                <tbody>
                {% for c in cases %}
                  <tr>
                    <td>{{ c.name }}</td>
                    <td>{{ c.code_list_string_rep|join:", " }}</td>
                  </tr>
                {% endfor %}
                </tbody>
              </table>
            </div>
            <div class="card mt-2">
              <div class="card-body">
                <div><strong>Total cases:</strong> {{ cases_total }}</div>
                <div><strong>Total files:</strong> {{ files_total }}</div>
                <div><strong>Your files total:</strong> {{ files_total_with_origin_current_user }}</div>
              </div>
            </div>
            <div class="card mt-2">
              <form action="{% url 'project:my_data_ground_truth_action' project.pk %}" method="post">
                <div class="card-body">
                  <div class="row mt-2" id="app">
                    <div class="col-6">
                      {% csrf_token %}
                      <div class="mb-3">
                        <label for="id_csv" class="form-label">CSV</label><span v-if="csvformatmessage"
                                                                                class="text-danger ms-3">[[ csvformatmessage ]]</span>
                        <textarea :disabled="encrypted" class="form-control" id="id_csv" @paste="checkCSVFormat"
                                  rows="25" name="ground_truth" v-model="csv"></textarea>
                      </div>
                      <div class="mb-3">
                        <label for="passphrase" class="form-label">Passphrase</label>
                        <input type="password" class="form-control" id="passphrase" v-model="passphrase">
                        <button type="button" :disabled="encrypted" id="btnEncrypt"
                                class="btn mt-2 btn-primary" @click="encrypt">Encrypt
                          <!-- in :disabled: || !validated -->
                        </button>
                        <button type="button" :disabled="!encrypted" id="btnDecrypt" class="btn mt-2 ms-2 btn-primary"
                                @click="decrypt">Decrypt
                        </button>
                        <span v-if="message" class="ms-3">[[ message ]]</span>
                      </div>

                      <div class="mb-3">
                        <button type="submit" :disabled="!encrypted" value="Save" id="submit-id-submit"
                                class="btn btn-primary">Save
                        </button>
                        <div class="spinner-border text-primary htmx-indicator" role="status"></div>

                      </div>
                    </div>
                    <div class="col-6">
                      <label for="csv_schema" class="form-label">CSV Schema</label>
                      <textarea disabled id="csv_schema" class="form-control" value="{{ csv_schema.yaml }}"
                                rows="20"></textarea>
                    </div>
                    <input type="hidden" name="nr_rows" class="form-control"
                           value="{{ files_total_with_origin_current_user }}">
                  </div>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>


  <script type="text/javascript">
    {% autoescape off %}
      $(document).ready(() => {
        let encrypted = {% if encrypted %}true{% else %}false{% endif %};
        const app = C.createLabelVueApp('#app', {
          csv: '{{ ground_truth.content|escapejs }}',
          encrypted
        });
        {# TODO call app.validate before enrypting #}
        {#app.validate();#}
      })
    {% endautoescape %}

    $('form').submit(function (e) {
      $(':disabled').each(function (e) {
        $(this).removeAttr('disabled');
      })
    });

    function copyText(text) {
      if (navigator.clipboard) {
        const type = "text/plain";
        const blob = new Blob([text], {type});
        const data = [new ClipboardItem({[type]: blob})];
        navigator.clipboard.write(data);
      }
    }
  </script>
{% endblock %}
